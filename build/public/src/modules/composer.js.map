{"version":3,"sources":["node_modules/nodebb-plugin-composer-default/static/lib/composer.js"],"names":["define","taskbar","translator","controls","uploads","formatting","drafts","tags","categoryList","preview","resize","autocomplete","scrollStop","composer","active","undefined","posts","bsEnvironment","$","window","off","onWindowResize","on","ev","data","localStorage","removeItem","cid","env","modified","discard","translate","translated","bootbox","confirm","removeComposerHistory","ajaxify","template","compose","history","back","utils","findBootstrapEnvironment","reposition","location","pathname","startsWith","mobileHistoryAppend","alreadyOpen","post","type","id","hasOwnProperty","uuid","push","generateUUID","existingUUID","updateActive","load","newTopicStr","title","parseInt","app","user","uid","save_id","join","tid","pid","updateVisibility","composerAlert","post_uuid","message","find","removeAttr","alert","timeout","alert_id","findByTid","addButton","iconClass","onClick","newTopic","action","body","isMain","addQuote","toPid","selectedPid","username","text","escapedTitle","replace","link","config","relative_path","newReply","postContainer","bodyEl","prevText","val","defaultLang","onTranslated","length","focusElements","render","editPost","socket","emit","err","threadData","alertError","handle","thumb","activate","onShow","createNewComposer","options","enhance","postData","attr","draft","getDraft","submitBtn","init","addHandler","addComposerButtons","handleToggler","removeClass","allowFileUploads","initialize","allowTopicsThumbnail","toggleThumbEls","this","e","preventDefault","btn","prop","matchScroll","handleHelp","screenfull","enabled","addClass","trigger","isTopic","isEditing","isGuestPost","mobile","resizable","isTopicOrMain","minimumTagLength","maximumTagLength","showHandleInput","allowGuestHandles","isAdmin","tagWhitelist","parseAndTranslate","composerTemplate","document","append","isActive","handleResize","submitBtns","mobileSubmitBtn","textareaEl","idx","toggleClass","composerData","apply","path","returnPath","slice","replaceState","url","pushState","callback","templates","parse","helpBtn","html","minimize","setTimeout","focus","putCursorAtEnd","handleEl","titleEl","thumbEl","onComposeRoute","trim","rtrim","checkTitle","isCategorySelected","inProgress","minimumTitleLength","maximumTitleLength","getTags","minimumTagsPerTopic","minimumPostLength","maximumPostLength","content","getSelectedCid","composerEl","showEmailConfirmWarning","removeDraft","go","slug","topic","onHide","css","paddingBottom","remove"],"mappings":"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","file":"node_modules/nodebb-plugin-composer-default/static/lib/composer.js","sourcesContent":["'use strict';\r\n\r\n/* globals define, socket, app, config, ajaxify, utils, templates, bootbox, screenfull */\r\n\r\ndefine('composer', [\r\n\t'taskbar',\r\n\t'translator',\r\n\t'composer/controls',\r\n\t'composer/uploads',\r\n\t'composer/formatting',\r\n\t'composer/drafts',\r\n\t'composer/tags',\r\n\t'composer/categoryList',\r\n\t'composer/preview',\r\n\t'composer/resize',\r\n\t'composer/autocomplete',\r\n\t'scrollStop'\r\n], function(taskbar, translator, controls, uploads, formatting, drafts, tags, categoryList, preview, resize, autocomplete, scrollStop) {\r\n\tvar composer = {\r\n\t\tactive: undefined,\r\n\t\tposts: {},\r\n\t\tbsEnvironment: undefined,\r\n\t\tformatting: undefined\r\n\t};\r\n\r\n\t$(window).off('resize', onWindowResize).on('resize', onWindowResize);\r\n\tonWindowResize();\r\n\r\n\t$(window).on('action:composer.topics.post', function(ev, data) {\r\n\t\tlocalStorage.removeItem('category:' + data.data.cid + ':bookmark');\r\n\t\tlocalStorage.removeItem('category:' + data.data.cid + ':bookmark:clicked');\r\n\t});\r\n\r\n\t$(window).on('popstate', function() {\r\n\t\tvar env = composer.bsEnvironment;\r\n\r\n\t\tif (composer.active && (env === 'xs' || env ==='sm')) {\r\n\t\t\tif (!composer.posts[composer.active].modified) {\r\n\t\t\t\tdiscard(composer.active);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\ttranslator.translate('[[modules:composer.discard]]', function(translated) {\r\n\t\t\t\tbootbox.confirm(translated, function(confirm) {\r\n\t\t\t\t\tif (confirm) {\r\n\t\t\t\t\t\tdiscard(composer.active);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n\r\n\tfunction removeComposerHistory() {\r\n\t\tvar env = composer.bsEnvironment;\r\n\t\tif (ajaxify.data.template.compose === true || env === 'xs' || env ==='sm') {\r\n\t\t\thistory.back();\r\n\t\t}\r\n\t}\r\n\r\n\tfunction onWindowResize() {\r\n\t\tvar env = utils.findBootstrapEnvironment();\r\n\t\tif (composer.active !== undefined) {\r\n\t\t\tresize.reposition($('#cmp-uuid-' + composer.active));\r\n\r\n\t\t\tif ((env === 'md' || env === 'lg') && window.location.pathname.startsWith('/compose')) {\r\n\t\t\t\t/*\r\n\t\t\t\t *\tIf this conditional is met, we're no longer in mobile/tablet\r\n\t\t\t\t *\tresolution but we've somehow managed to have a mobile\r\n\t\t\t\t *\tcomposer load, so let's go back to the topic\r\n\t\t\t\t */\r\n\t\t\t\thistory.back();\r\n\t\t\t} else if ((env === 'xs' || env === 'sm') && !window.location.pathname.startsWith('/compose')) {\r\n\t\t\t\t/*\r\n\t\t\t\t *\tIn this case, we're in mobile/tablet resolution but the composer\r\n\t\t\t\t *\tthat loaded was a regular composer, so let's fix the address bar\r\n\t\t\t\t */\r\n\t\t\t\tmobileHistoryAppend();\r\n\t\t\t}\r\n\t\t}\r\n\t\tcomposer.bsEnvironment = env;\r\n\t}\r\n\r\n\tfunction alreadyOpen(post) {\r\n\t\t// If a composer for the same cid/tid/pid is already open, return the uuid, else return bool false\r\n\t\tvar\ttype, id;\r\n\r\n\t\tif (post.hasOwnProperty('cid')) {\r\n\t\t\ttype = 'cid';\r\n\t\t} else if (post.hasOwnProperty('tid')) {\r\n\t\t\ttype = 'tid';\r\n\t\t} else if (post.hasOwnProperty('pid')) {\r\n\t\t\ttype = 'pid';\r\n\t\t}\r\n\r\n\t\tid = post[type];\r\n\r\n\t\t// Find a match\r\n\t\tfor(var uuid in composer.posts) {\r\n\t\t\tif (composer.posts[uuid].hasOwnProperty(type) && id === composer.posts[uuid][type]) {\r\n\t\t\t\treturn uuid;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// No matches...\r\n\t\treturn false;\r\n\t}\r\n\r\n\tfunction push(post) {\r\n\t\tvar uuid = utils.generateUUID(),\r\n\t\t\texistingUUID = alreadyOpen(post);\r\n\r\n\t\tif (existingUUID) {\r\n\t\t\ttaskbar.updateActive(existingUUID);\r\n\t\t\treturn composer.load(existingUUID);\r\n\t\t}\r\n\r\n\t\ttranslator.translate('[[topic:composer.new_topic]]', function(newTopicStr) {\r\n\t\t\ttaskbar.push('composer', uuid, {\r\n\t\t\t\ttitle: post.title ? post.title : newTopicStr\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\t// Construct a save_id\r\n\t\tif (0 !== parseInt(app.user.uid, 10)) {\r\n\t\t\tif (post.hasOwnProperty('cid')) {\r\n\t\t\t\tpost.save_id = ['composer', app.user.uid, 'cid', post.cid].join(':');\r\n\t\t\t} else if (post.hasOwnProperty('tid')) {\r\n\t\t\t\tpost.save_id = ['composer', app.user.uid, 'tid', post.tid].join(':');\r\n\t\t\t} else if (post.hasOwnProperty('pid')) {\r\n\t\t\t\tpost.save_id = ['composer', app.user.uid, 'pid', post.pid].join(':');\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Post is opened, save to list of opened drafts\r\n\t\tdrafts.updateVisibility(post.save_id, true);\r\n\r\n\t\tcomposer.posts[uuid] = post;\r\n\t\tcomposer.load(uuid);\r\n\t}\r\n\r\n\tfunction composerAlert(post_uuid, message) {\r\n\t\t$('#cmp-uuid-' + post_uuid).find('.composer-submit').removeAttr('disabled');\r\n\t\tapp.alert({\r\n\t\t\ttype: 'danger',\r\n\t\t\ttimeout: 3000,\r\n\t\t\ttitle: '',\r\n\t\t\tmessage: message,\r\n\t\t\talert_id: 'post_error'\r\n\t\t});\r\n\t}\r\n\r\n\tcomposer.findByTid = function(tid) {\r\n\t\t// Iterates through the initialised composers and returns the uuid of the matching composer\r\n\t\tfor(var uuid in composer.posts) {\r\n\t\t\tif (composer.posts.hasOwnProperty(uuid) && composer.posts[uuid].hasOwnProperty('tid') && parseInt(composer.posts[uuid].tid, 10) === parseInt(tid, 10)) {\r\n\t\t\t\treturn uuid;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn null;\r\n\t};\r\n\r\n\tcomposer.addButton = function(iconClass, onClick, title) {\r\n\t\tformatting.addButton(iconClass, onClick, title);\r\n\t};\r\n\r\n\tcomposer.newTopic = function(data) {\r\n\t\tpush({\r\n\t\t\taction: 'topics.post',\r\n\t\t\tcid: data.cid,\r\n\t\t\ttitle: data.title || '',\r\n\t\t\tbody: data.body || '',\r\n\t\t\ttags: data.tags || [],\r\n\t\t\tmodified: false,\r\n\t\t\tisMain: true\r\n\t\t});\r\n\t};\r\n\r\n\tcomposer.addQuote = function(tid, toPid, selectedPid, title, username, text, uuid) {\r\n\t\tuuid = uuid || composer.active;\r\n\r\n\t\tvar escapedTitle = (title || '').replace(/([\\\\`*_{}\\[\\]()#+\\-.!])/g, '\\\\$1').replace(/\\[/g, '&#91;').replace(/\\]/g, '&#93;').replace(/%/g, '&#37;').replace(/,/g, '&#44;');\r\n\r\n\t\tif (text) {\r\n\t\t\ttext = '> ' + text.replace(/\\n/g, '\\n> ') + '\\n\\n';\r\n\t\t}\r\n\t\tvar link = '[' + escapedTitle + '](' + config.relative_path + '/post/' + (selectedPid || toPid) + ')';\r\n\t\tif (uuid === undefined) {\r\n\t\t\tif (title && (selectedPid || toPid)) {\r\n\t\t\t\tcomposer.newReply(tid, toPid, title, '[[modules:composer.user_said_in, ' + username + ', ' + link + ']]\\n' + text);\r\n\t\t\t} else {\r\n\t\t\t\tcomposer.newReply(tid, toPid, title, '[[modules:composer.user_said, ' + username + ']]\\n' + text);\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t} else if (uuid !== composer.active) {\r\n\t\t\t// If the composer is not currently active, activate it\r\n\t\t\tcomposer.load(uuid);\r\n\t\t}\r\n\r\n\t\tvar postContainer = $('#cmp-uuid-' + uuid);\r\n\t\tvar bodyEl = postContainer.find('textarea');\r\n\t\tvar prevText = bodyEl.val();\r\n\t\tif (title && (selectedPid || toPid)) {\r\n\t\t\ttranslator.translate('[[modules:composer.user_said_in, ' + username + ', ' + link + ']]\\n', config.defaultLang, onTranslated);\r\n\t\t} else {\r\n\t\t\ttranslator.translate('[[modules:composer.user_said, ' + username + ']]\\n', config.defaultLang, onTranslated);\r\n\t\t}\r\n\r\n\t\tfunction onTranslated(translated) {\r\n\t\t\tcomposer.posts[uuid].body = (prevText.length ? prevText + '\\n\\n' : '') + translated + text;\r\n\t\t\tbodyEl.val(composer.posts[uuid].body);\r\n\t\t\tfocusElements(postContainer);\r\n\t\t\tpreview.render(postContainer);\r\n\t\t}\r\n\t};\r\n\r\n\tcomposer.newReply = function(tid, toPid, title, text) {\r\n\t\ttranslator.translate(text, config.defaultLang, function(translated) {\r\n\t\t\tpush({\r\n\t\t\t\taction: 'posts.reply',\r\n\t\t\t\ttid: tid,\r\n\t\t\t\ttoPid: toPid,\r\n\t\t\t\ttitle: title,\r\n\t\t\t\tbody: translated,\r\n\t\t\t\tmodified: false,\r\n\t\t\t\tisMain: false\r\n\t\t\t});\r\n\t\t});\r\n\t};\r\n\r\n\tcomposer.editPost = function(pid) {\r\n\t\tsocket.emit('plugins.composer.push', pid, function(err, threadData) {\r\n\t\t\tif (err) {\r\n\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t}\r\n\r\n\t\t\tpush({\r\n\t\t\t\taction: 'posts.edit',\r\n\t\t\t\tpid: pid,\r\n\t\t\t\tuid: threadData.uid,\r\n\t\t\t\thandle: threadData.handle,\r\n\t\t\t\ttitle: threadData.title,\r\n\t\t\t\tbody: threadData.body,\r\n\t\t\t\tmodified: false,\r\n\t\t\t\tisMain: threadData.isMain,\r\n\t\t\t\tthumb: threadData.thumb,\r\n\t\t\t\ttags: threadData.tags\r\n\t\t\t});\r\n\t\t});\r\n\t};\r\n\r\n\tcomposer.load = function(post_uuid) {\r\n\t\tvar postContainer = $('#cmp-uuid-' + post_uuid);\r\n\t\tif (postContainer.length) {\r\n\t\t\tactivate(post_uuid);\r\n\t\t\tresize.reposition(postContainer);\r\n\t\t\tfocusElements(postContainer);\r\n\t\t\tonShow();\r\n\t\t} else {\r\n\t\t\tif (composer.formatting) {\r\n\t\t\t\tcreateNewComposer(post_uuid);\r\n\t\t\t} else {\r\n\t\t\t\tsocket.emit('plugins.composer.getFormattingOptions', function(err, options) {\r\n\t\t\t\t\tcomposer.formatting = options;\r\n\t\t\t\t\tcreateNewComposer(post_uuid);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\r\n\tcomposer.enhance = function(postContainer, post_uuid, postData) {\r\n\t\t/*\r\n\t\t\tThis method enhances a composer container with client-side sugar (preview, etc)\r\n\t\t\tEverything in here also applies to the /compose route\r\n\t\t*/\r\n\r\n\t\tif (!post_uuid && !postData) {\r\n\t\t\tpost_uuid = utils.generateUUID();\r\n\t\t\tcomposer.posts[post_uuid] = postData = ajaxify.data;\r\n\t\t\tpostContainer.attr('id', 'cmp-uuid-' + post_uuid);\r\n\t\t}\r\n\r\n\t\tvar bodyEl = postContainer.find('textarea');\r\n\t\tvar draft = drafts.getDraft(postData.save_id);\r\n\t\tvar submitBtn = postContainer.find('.composer-submit');\r\n\r\n\t\tcategoryList.init(postContainer, composer.posts[post_uuid]);\r\n\r\n\t\tformatting.addHandler(postContainer);\r\n\t\tformatting.addComposerButtons();\r\n\t\tpreview.handleToggler(postContainer);\r\n\r\n\t\tpostContainer.find('.img-upload-btn').removeClass('hide');\r\n\t\tpostContainer.find('#files.lt-ie9').removeClass('hide');\r\n\r\n\t\tif (config.allowFileUploads) {\r\n\t\t\tpostContainer.find('.file-upload-btn').removeClass('hide');\r\n\t\t\tpostContainer.find('#files.lt-ie9').removeClass('hide');\r\n\t\t}\r\n\r\n\t\tuploads.initialize(post_uuid, ajaxify.data.cid);\r\n\r\n\t\tif (config.allowTopicsThumbnail && postData.isMain) {\r\n\t\t\tuploads.toggleThumbEls(postContainer, composer.posts[post_uuid].thumb || '');\r\n\t\t}\r\n\r\n\t\tautocomplete.init(postContainer);\r\n\r\n\t\tpostContainer.on('change', 'input, textarea', function() {\r\n\t\t\tcomposer.posts[post_uuid].modified = true;\r\n\t\t});\r\n\r\n\t\tsubmitBtn.on('click', function() {\r\n\t\t\t$(this).attr('disabled', true);\r\n\t\t\tpost(post_uuid);\r\n\t\t});\r\n\r\n\t\tpostContainer.find('.composer-discard').on('click', function(e) {\r\n\t\t\te.preventDefault();\r\n\r\n\t\t\tif (!composer.posts[post_uuid].modified) {\r\n\t\t\t\tremoveComposerHistory();\r\n\t\t\t\tdiscard(post_uuid);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tvar btn = $(this).prop('disabled', true);\r\n\t\t\ttranslator.translate('[[modules:composer.discard]]', function(translated) {\r\n\t\t\t\tbootbox.confirm(translated, function(confirm) {\r\n\t\t\t\t\tif (confirm) {\r\n\t\t\t\t\t\tremoveComposerHistory();\r\n\t\t\t\t\t\tdiscard(post_uuid);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbtn.prop('disabled', false);\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tbodyEl.on('input propertychange', function() {\r\n\t\t\tpreview.render(postContainer);\r\n\t\t});\r\n\r\n\t\tbodyEl.on('scroll', function() {\r\n\t\t\tpreview.matchScroll(postContainer);\r\n\t\t});\r\n\r\n\t\tpreview.render(postContainer, function() {\r\n\t\t\tpreview.matchScroll(postContainer);\r\n\t\t});\r\n\r\n\t\tbodyEl.val(draft ? draft : postData.body);\r\n\t\tdrafts.init(postContainer, postData);\r\n\r\n\t\thandleHelp(postContainer);\r\n\r\n\t\tfocusElements(postContainer);\r\n\r\n\t\t// Hide \"zen mode\" if fullscreen API is not enabled/available (ahem, iOS...)\r\n\t\tif (typeof screenfull !== 'undefined' && !screenfull.enabled) {\r\n\t\t\t$('[data-format=\"zen\"]').addClass('hidden');\r\n\t\t}\r\n\r\n\t\t$(window).trigger('action:composer.enhanced');\r\n\t};\r\n\r\n\tfunction createNewComposer(post_uuid) {\r\n\t\tvar postData = composer.posts[post_uuid];\r\n\r\n\t\tvar allowTopicsThumbnail = config.allowTopicsThumbnail && postData.isMain,\r\n\t\t\tisTopic = postData ? postData.hasOwnProperty('cid') : false,\r\n\t\t\tisMain = postData ? !!postData.isMain : false,\r\n\t\t\tisEditing = postData ? !!postData.pid : false,\r\n\t\t\tisGuestPost = postData ? parseInt(postData.uid, 10) === 0 : false;\r\n\r\n\t\t// see\r\n\t\t// https://github.com/NodeBB/NodeBB/issues/2994 and\r\n\t\t// https://github.com/NodeBB/NodeBB/issues/1951\r\n\t\t// remove when 1951 is resolved\r\n\r\n\t\tvar title = postData.title.replace(/%/g, '&#37;').replace(/,/g, '&#44;');\r\n\r\n\t\tvar data = {\r\n\t\t\ttitle: title,\r\n\t\t\tmobile: composer.bsEnvironment === 'xs' || composer.bsEnvironment === 'sm',\r\n\t\t\tresizable: true,\r\n\t\t\tallowTopicsThumbnail: allowTopicsThumbnail,\r\n\t\t\tisTopicOrMain: isTopic || isMain,\r\n\t\t\tminimumTagLength: config.minimumTagLength,\r\n\t\t\tmaximumTagLength: config.maximumTagLength,\r\n\t\t\tisTopic: isTopic,\r\n\t\t\tisEditing: isEditing,\r\n\t\t\tshowHandleInput:  config.allowGuestHandles && (app.user.uid === 0 || (isEditing && isGuestPost && app.user.isAdmin)),\r\n\t\t\thandle: postData ? postData.handle || '' : undefined,\r\n\t\t\tformatting: composer.formatting,\r\n\t\t\ttagWhitelist: ajaxify.data.tagWhitelist\r\n\t\t};\r\n\r\n\t\tif (data.mobile) {\r\n\t\t\tmobileHistoryAppend();\r\n\t\t}\r\n\r\n\t\tparseAndTranslate('composer', data, function(composerTemplate) {\r\n\t\t\tif ($('#cmp-uuid-' + post_uuid).length) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tcomposerTemplate = $(composerTemplate);\r\n\r\n\t\t\tcomposerTemplate.attr('id', 'cmp-uuid-' + post_uuid);\r\n\r\n\t\t\t$(document.body).append(composerTemplate);\r\n\r\n\t\t\tvar postContainer = $(composerTemplate[0]);\r\n\r\n\t\t\tresize.reposition(postContainer);\r\n\t\t\tcomposer.enhance(postContainer, post_uuid, postData);\r\n\t\t\t/*\r\n\t\t\t\tEverything after this line is applied to the resizable composer only\r\n\t\t\t\tWant something done to both resizable composer and the one in /compose?\r\n\t\t\t\tPut it in composer.enhance().\r\n\r\n\t\t\t\tEventually, stuff after this line should be moved into composer.enhance().\r\n\t\t\t*/\r\n\r\n\t\t\ttags.init(postContainer, composer.posts[post_uuid]);\r\n\r\n\t\t\tactivate(post_uuid);\r\n\r\n\t\t\tpostContainer.on('click', function() {\r\n\t\t\t\tif (!taskbar.isActive(post_uuid)) {\r\n\t\t\t\t\ttaskbar.updateActive(post_uuid);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\tresize.handleResize(postContainer);\r\n\r\n\t\t\tif (composer.bsEnvironment === 'xs' || composer.bsEnvironment === 'sm') {\r\n\t\t\t\tvar submitBtns = postContainer.find('.composer-submit'),\r\n\t\t\t\t\tmobileSubmitBtn = postContainer.find('.mobile-navbar .composer-submit'),\r\n\t\t\t\t\ttextareaEl = postContainer.find('.write'),\r\n\t\t\t\t\tidx = textareaEl.attr('tabindex');\r\n\r\n\t\t\t\tsubmitBtns.removeAttr('tabindex');\r\n\t\t\t\tmobileSubmitBtn.attr('tabindex', parseInt(idx, 10)+1);\r\n\r\n\t\t\t\t$('.category-name-container').on('click', function() {\r\n\t\t\t\t\t$('.category-selector').toggleClass('open');\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\t$(window).trigger('action:composer.loaded', {\r\n\t\t\t\tpost_uuid: post_uuid,\r\n\t\t\t\tcomposerData: composer.posts[post_uuid]\r\n\t\t\t});\r\n\r\n\t\t\tscrollStop.apply(postContainer.find('.write'));\r\n\t\t\tfocusElements(postContainer);\r\n\t\t\tonShow();\r\n\t\t});\r\n\r\n\t}\r\n\r\n\tfunction mobileHistoryAppend() {\r\n\t\tvar path = 'compose?p=' + window.location.pathname,\r\n\t\t\treturnPath = window.location.pathname.slice(1);\r\n\r\n\t\t// Remove relative path from returnPath\r\n\t\tif (returnPath.startsWith(config.relative_path.slice(1))) {\r\n\t\t\treturnPath = returnPath.slice(config.relative_path.length);\r\n\t\t}\r\n\r\n\t\t// Add in return path to be caught by ajaxify when post is completed, or if back is pressed\r\n\t\twindow.history.replaceState({\r\n\t\t\turl: null,\r\n\t\t\treturnPath: returnPath\r\n\t\t}, returnPath, config.relative_path + '/' + returnPath);\r\n\r\n\t\t// Update address bar in case f5 is pressed\r\n\t\twindow.history.pushState({\r\n\t\t\turl: path\r\n\t\t}, path, config.relative_path + '/' + path);\r\n\t}\r\n\r\n\tfunction parseAndTranslate(template, data, callback) {\r\n\t\ttemplates.parse(template, data, function(composerTemplate) {\r\n\t\t\ttranslator.translate(composerTemplate, callback);\r\n\t\t});\r\n\t}\r\n\r\n\tfunction handleHelp(postContainer) {\r\n\t\tvar helpBtn = postContainer.find('.help');\r\n\t\tsocket.emit('plugins.composer.renderHelp', function(err, html) {\r\n\t\t\tif (!err && html && html.length > 0) {\r\n\t\t\t\thelpBtn.removeClass('hidden');\r\n\t\t\t\thelpBtn.on('click', function() {\r\n\t\t\t\t\tbootbox.alert(html);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tfunction activate(post_uuid) {\r\n\t\tif(composer.active && composer.active !== post_uuid) {\r\n\t\t\tcomposer.minimize(composer.active);\r\n\t\t}\r\n\r\n\t\tcomposer.active = post_uuid;\r\n\t}\r\n\r\n\tfunction focusElements(postContainer) {\r\n\t\tsetTimeout(function() {\r\n\t\t\tvar title = postContainer.find('input.title');\r\n\r\n\t\t\tif (title.length) {\r\n\t\t\t\ttitle.focus();\r\n\t\t\t} else {\r\n\t\t\t\tpostContainer.find('textarea').focus().putCursorAtEnd();\r\n\t\t\t}\r\n\t\t}, 1);\r\n\t}\r\n\r\n\tfunction post(post_uuid) {\r\n\t\tvar postData = composer.posts[post_uuid];\r\n\t\tvar postContainer = $('#cmp-uuid-' + post_uuid);\r\n\t\tvar handleEl = postContainer.find('.handle');\r\n\t\tvar titleEl = postContainer.find('.title');\r\n\t\tvar bodyEl = postContainer.find('textarea');\r\n\t\tvar thumbEl = postContainer.find('input#topic-thumb-url');\r\n\t\tvar onComposeRoute = postData.hasOwnProperty('template') && postData.template.compose === true;\r\n\r\n\t\ttitleEl.val(titleEl.val().trim());\r\n\t\tbodyEl.val(utils.rtrim(bodyEl.val()));\r\n\t\tif (thumbEl.length) {\r\n\t\t\tthumbEl.val(thumbEl.val().trim());\r\n\t\t}\r\n\r\n\t\tvar action = postData.action;\r\n\r\n\t\tvar checkTitle = (postData.hasOwnProperty('cid') || parseInt(postData.pid, 10)) && postContainer.find('input.title').length;\r\n\t\tvar isCategorySelected = !checkTitle || (checkTitle && parseInt(postData.cid, 10));\r\n\r\n\t\tif (uploads.inProgress[post_uuid] && uploads.inProgress[post_uuid].length) {\r\n\t\t\treturn composerAlert(post_uuid, '[[error:still-uploading]]');\r\n\t\t} else if (checkTitle && titleEl.val().length < parseInt(config.minimumTitleLength, 10)) {\r\n\t\t\treturn composerAlert(post_uuid, '[[error:title-too-short, ' + config.minimumTitleLength + ']]');\r\n\t\t} else if (checkTitle && titleEl.val().length > parseInt(config.maximumTitleLength, 10)) {\r\n\t\t\treturn composerAlert(post_uuid, '[[error:title-too-long, ' + config.maximumTitleLength + ']]');\r\n\t\t} else if (action === 'topics.post' && !isCategorySelected) {\r\n\t\t\treturn composerAlert(post_uuid, '[[error:category-not-selected]]');\r\n\t\t} else if (checkTitle && tags.getTags(post_uuid) && tags.getTags(post_uuid).length < parseInt(config.minimumTagsPerTopic, 10)) {\r\n\t\t\treturn composerAlert(post_uuid, '[[error:not-enough-tags, ' + config.minimumTagsPerTopic + ']]');\r\n\t\t} else if (bodyEl.val().length < parseInt(config.minimumPostLength, 10)) {\r\n\t\t\treturn composerAlert(post_uuid, '[[error:content-too-short, ' + config.minimumPostLength + ']]');\r\n\t\t} else if (bodyEl.val().length > parseInt(config.maximumPostLength, 10)) {\r\n\t\t\treturn composerAlert(post_uuid, '[[error:content-too-long, ' + config.maximumPostLength + ']]');\r\n\t\t}\r\n\r\n\t\tvar composerData = {};\r\n\r\n\t\tif (action === 'topics.post') {\r\n\t\t\tcomposerData = {\r\n\t\t\t\thandle: handleEl ? handleEl.val() : undefined,\r\n\t\t\t\ttitle: titleEl.val(),\r\n\t\t\t\tcontent: bodyEl.val(),\r\n\t\t\t\tthumb: thumbEl.val() || '',\r\n\t\t\t\tcid: categoryList.getSelectedCid(),\r\n\t\t\t\ttags: tags.getTags(post_uuid)\r\n\t\t\t};\r\n\t\t} else if (action === 'posts.reply') {\r\n\t\t\tcomposerData = {\r\n\t\t\t\ttid: postData.tid,\r\n\t\t\t\thandle: handleEl ? handleEl.val() : undefined,\r\n\t\t\t\tcontent: bodyEl.val(),\r\n\t\t\t\ttoPid: postData.toPid\r\n\t\t\t};\r\n\t\t} else if (action === 'posts.edit') {\r\n\t\t\tcomposerData = {\r\n\t\t\t\tpid: postData.pid,\r\n\t\t\t\thandle: handleEl ? handleEl.val() : undefined,\r\n\t\t\t\tcontent: bodyEl.val(),\r\n\t\t\t\ttitle: titleEl.val(),\r\n\t\t\t\tthumb: thumbEl.val() || '',\r\n\t\t\t\ttags: tags.getTags(post_uuid)\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t\t$(window).trigger('action:composer.submit', {composerEl: postContainer, action: action, composerData: composerData});\r\n\r\n\t\tsocket.emit(action, composerData, function (err, data) {\r\n\t\t\tpostContainer.find('.composer-submit').removeAttr('disabled');\r\n\t\t\tif (err) {\r\n\t\t\t\tif (err.message === '[[error:email-not-confirmed]]') {\r\n\t\t\t\t\treturn app.showEmailConfirmWarning(err);\r\n\t\t\t\t}\r\n\r\n\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t}\r\n\r\n\t\t\tdiscard(post_uuid);\r\n\t\t\tdrafts.removeDraft(postData.save_id);\r\n\r\n\t\t\tif (action === 'topics.post') {\r\n\t\t\t\tajaxify.go('topic/' + data.slug, undefined, (onComposeRoute || composer.bsEnvironment === 'xs' || composer.bsEnvironment === 'sm') ? true : false);\r\n\t\t\t} else if (action === 'posts.reply') {\r\n\t\t\t\tif (onComposeRoute || composer.bsEnvironment === 'xs' || composer.bsEnvironment === 'sm') {\r\n\t\t\t\t\twindow.history.back();\r\n\t\t\t\t} else if (ajaxify.data.template.topic) {\r\n\t\t\t\t\tif (parseInt(postData.tid, 10) !== parseInt(ajaxify.data.tid, 10)) {\r\n\t\t\t\t\t\tajaxify.go('post/' + data.pid);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// else, we're in the same topic, no nav required\r\n\t\t\t\t} else {\r\n\t\t\t\t\tajaxify.go('post/' + data.pid);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tremoveComposerHistory();\r\n\t\t\t}\r\n\r\n\t\t\t$(window).trigger('action:composer.' + action, { composerData: composerData, data: data });\r\n\t\t});\r\n\t}\r\n\r\n\tfunction onShow() {\r\n\t\t$('html').addClass('composing');\r\n\t}\r\n\r\n\tfunction onHide() {\r\n\t\t$('body').css({ paddingBottom: 0 });\r\n\t\t$('html').removeClass('composing');\r\n\t}\r\n\r\n\tfunction discard(post_uuid) {\r\n\t\tif (composer.posts[post_uuid]) {\r\n\t\t\t$('#cmp-uuid-' + post_uuid).remove();\r\n\t\t\tdrafts.removeDraft(composer.posts[post_uuid].save_id);\r\n\r\n\t\t\tdelete composer.posts[post_uuid];\r\n\t\t\tcomposer.active = undefined;\r\n\t\t\ttaskbar.discard('composer', post_uuid);\r\n\t\t\t$('[data-action=\"post\"]').removeAttr('disabled');\r\n\r\n\t\t\t$(window).trigger('action:composer.discard');\r\n\t\t}\r\n\t\tonHide();\r\n\t}\r\n\r\n\tcomposer.minimize = function(post_uuid) {\r\n\t\tvar postContainer = $('#cmp-uuid-' + post_uuid);\r\n\t\tpostContainer.css('visibility', 'hidden');\r\n\t\tcomposer.active = undefined;\r\n\t\ttaskbar.minimize('composer', post_uuid);\r\n\r\n\t\tonHide();\r\n\t};\r\n\r\n\treturn composer;\r\n});\r\n"]}